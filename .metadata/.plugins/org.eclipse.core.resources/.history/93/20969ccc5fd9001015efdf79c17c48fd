package com.fitness.aiservice.service;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.List;

import org.springframework.stereotype.Service;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fitness.modelservice.Activity;
import com.fitness.modelservice.Recommendation;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

@Service
@Slf4j
@RequiredArgsConstructor
public class ActivityAIService {

    private final GeminiService geminiService;

    public Recommendation generateRecommendation(Activity activity) {
        String prompt = createPromptForActivity(activity);
        String aiResponse = geminiService.getAnswer(prompt);
        log.info("RESPONSE_FROM_AI: {}", aiResponse);
        return processAiResponse(activity, aiResponse);
    }
    
    private Recommendation processAiResponse(Activity activity , String aiResponse) {
        try {
            ObjectMapper mapper = new ObjectMapper();
            JsonNode rootNode = mapper.readTree(aiResponse);

//            JsonNode candidates = rootNode.path("candidates");
//            if (!candidates.isArray() || candidates.size() == 0) {
//                log.error("No candidates found");
//                return;
//            }
//
//            JsonNode parts = candidates.get(0).path("content").path("parts");
//            if (!parts.isArray() || parts.size() == 0) {
//                log.error("No parts found");
//                return;
//            }

            JsonNode textNode = rootNode.path("candidates")
            		.get(0)
            		.path("content")
            		.path("parts")
            		.get(0)
            		.path("text");
            		 
            String jsonContent = textNode.asText()
                    .replace("```json", "")
                    .replace("```", "")
                    .trim();

//            log.info("PARSED JSON CONTENT: {}", jsonContent);
            
            JsonNode analysisJson = mapper.readTree(jsonContent);
            JsonNode analysisNode = analysisJson.path("analysis");
            
            StringBuilder fullAnalysis = new StringBuilder();
            addAnalysisSection(fullAnalysis,analysisNode,"overall","Overall : ");
            addAnalysisSection(fullAnalysis,analysisNode,"pace","Pace : ");
            addAnalysisSection(fullAnalysis,analysisNode,"heartRate","Heart Rate : ");
            addAnalysisSection(fullAnalysis,analysisNode,"caloriesBurned","Calories Burned : ");
            
            List<String> improvements = extractImprovements(analysisJson.path("improvements"));
            
            List<String> suggestions = extractSuggestions(analysisJson.path("suggestions"));

            List<String> safety = extractSafetyGuidelines(analysisJson.path("safety"));
            
            return Recommendation.builder()
            		.activityId(activity.getId())
            		.userId(activity.getUserId())
            		.activityType(activity.getType().name())
            		.recommendation(fullAnalysis.toString().trim())
            		.improvements(improvements)
            		.suggestions(suggestions)
            		.safety(safety)
            		.createdAt(LocalDateTime.now())
            		.build();

            
        } catch (Exception e) {
            log.error("Failed to process AI response", e);
            return createDefaultRecommendation(activity);
        }
    }


    private Recommendation createDefaultRecommendation(Activity activity) {
    	return Recommendation.builder()
    			.activityId(activity.getId())
        		.userId(activity.getUserId())
        		.activityType(activity.getType().name())
        		.recommendation("Unable able to generate detailed analysis.")
        		.improvements(Collections.singletonList("Continue with your current routine."))
        		.suggestions(Collections.singletonList("Consider consulting a fitness professional."))
        		.safety(Arrays.asList(
        				"Always warm upm "))
        		.build();
	}

	private List<String> extractSafetyGuidelines(JsonNode safetyNode) {
    	List<String> safety = new ArrayList<>();
    	if(safetyNode.isArray()) {
    		safetyNode.forEach(item -> safety.add(item.asText()));
    	}
    		
		return safety.isEmpty() ?
				Collections.singletonList("Follow General Safety Guidelines") :
					safety;
		}

	private List<String> extractSuggestions(JsonNode suggestionsNode) {
    	List<String> suggestions = new ArrayList<>();
    	if (suggestionsNode.isArray()) {
    		suggestionsNode.forEach(suggestion -> {
    			String workout = suggestion.path("workout").asText();
    			String description = suggestion.path("description").asText();
    			suggestions.add(String.format("%s: %s", workout, description)); 
    		});
    	}
    	
    	return suggestions.isEmpty() ?
				Collections.singletonList("No specific suggestions provided") :
					suggestions;
    	}

	private List<String> extractImprovements(JsonNode improvementsNode) {
    	List<String> improvements = new ArrayList<>();
    	if(improvementsNode.isArray()) {
    		improvementsNode.forEach(improvement -> {
    			String area = improvement.path("area").asText();
    			String detail = improvement.path("recommendation").asText();
    			improvements.add(String.format("%s: %s", area, detail));
    		});	
    	}
		return improvements.isEmpty() ?
				Collections.singletonList("No specific improvements provided") :
					improvements;
	}

	private void addAnalysisSection(StringBuilder fullAnalysis, JsonNode analysisNode, String key, String prefix) {
    	if (!analysisNode.path(key).isMissingNode()) {
    		fullAnalysis.append(prefix)
    			.append(analysisNode.path(key).asText())
    			.append("\n\n");
    	}
	}

	private String createPromptForActivity(Activity activity) {

        String extraMetrics = switch (activity.getType()) {
            case RUNNING -> "\"pace\": \"\", \"distance\": \"\"";
            case CYCLING -> "\"cadence\": \"\", \"elevation\": \"\"";
            case SWIMMING -> "\"strokes\": \"\", \"laps\": \"\"";
            case WEIGHT_TRAINING -> "\"reps\": \"\", \"sets\": \"\"";
            case HIIT -> "\"intensity\": \"\", \"recovery\": \"\"";
            case YOGA, STRETCHING -> "\"flexibility\": \"\", \"balance\": \"\"";
            case WALKING -> "\"steps\": \"\", \"speed\": \"\"";
            case CARDIO -> "\"resistance\": \"\", \"endurance\": \"\"";
            default -> "\"intensityLevel\": \"\"";
        };

        return String.format(
            """
            You are a fitness consultant who gives friendly advice with comforting phrases like “you should”, “I suggest”, “it’s better for you”, and “try doing”. 
            You must make the user feel supported and motivated.

            Analyze this fitness activity and provide detailed guidance. 
            Your response MUST be in valid JSON only — no code blocks, no explanations outside JSON.

            Use the EXACT JSON structure below:

            {
              "analysis": {
                "overall": "",
                "age": "",
                "heartRate": "",
                "caloriesBurned": "",
                %s
              },
              "improvements": [
                {
                  "area": "",
                  "recommendation": ""
                }
              ],
              "suggestions": [
                {
                  "workout": "",
                  "description": ""
                }
              ],
              "safety": [
                ""
              ]
            }

            Activity Details:
            Activity Type: %s
            Duration: %d minutes
            Calories Burned: %d
            Additional Metrics: %s

            Ensure the analysis feels like it is personally directed to the user with empathy and health-first recommendations.
            Respond strictly as JSON.
            """,
            extraMetrics,
            activity.getType(),
            activity.getDuration(),
            activity.getCaloriesBurned(),
            activity.getAdditionalMetrics()
        );
    }
}
